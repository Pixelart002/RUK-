<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultra Legendary Military IDE — AI Auto Dev (Final)</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<script src="https://unpkg.com/split.js/dist/split.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css"/>
<script src="https://unpkg.com/xterm/lib/xterm.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.46.0/min/vs/loader.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    --bg:#071427; --panel:#0b1522; --muted:#98a2b3; --bright:#e6eef8; --accent:#60a5fa;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#041223);color:var(--bright);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
  .topbar{height:56px;display:flex;align-items:center;padding:8px 12px;background:#051324;border-bottom:1px solid rgba(255,255,255,0.04)}
  .brand{font-weight:700;margin-right:12px}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--bright);cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#2563eb,#7c3aed);border:none}
  .badge{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.06);color:var(--muted)}
  .status-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:8px}
  .idle{background:#64748b}.ok{background:#22c55e}.err{background:#ef4444}

  /* Main layout */
  #root{position:fixed;inset:56px 0 0 0;display:flex;flex-direction:column}
  .top-split{height:65%;display:flex;gap:10px;padding:12px}
  .bottom-split{height:35%;display:flex;gap:10px;padding:12px}
  .panel{background:var(--panel);border-radius:10px;padding:10px;box-shadow:0 6px 20px rgba(0,0,0,0.6);display:flex;flex-direction:column;overflow:hidden}
  .panel .title{font-size:12px;color:var(--muted);margin-bottom:8px}
  #file-list{overflow:auto;flex:1}
  .file-item{padding:6px;border-radius:6px;display:flex;justify-content:space-between;align-items:center;color:var(--bright);cursor:pointer}
  .file-item:hover{background:rgba(255,255,255,0.02)}
  #editor {flex:1;border-radius:8px;overflow:hidden;min-height:120px}
  .log{font-family:ui-monospace,monospace;font-size:13px;color:var(--muted);white-space:pre-wrap;overflow:auto}
  .input{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--bright)}
  .small{font-size:12px;color:var(--muted)}
  .badge-small{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.04);color:var(--muted)}
  .term-wrapper{height:100%;width:100%;overflow:hidden;border-radius:8px}

  /* Toggles */
  .hidden{display:none!important}

  /* Responsive adjustments (layout.js will also control classes) */
  @media (max-width: 900px){
    .top-split{flex-direction:column;height:60%}
    .bottom-split{flex-direction:column;height:40%}
    .top-split > .panel{width:100% !important}
    .bottom-split > .panel{width:100% !important}
    #root{inset:56px 0 0 0}
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Ultra Legendary Military IDE</div>
    <div class="small">LangChain-style orchestration (Gemini) · WebContainers (Node) · Pyodide (Python) · Monaco · xterm</div>
    <div class="controls">
      <span class="badge"><span id="nodeDot" class="status-dot idle"></span>Node</span>
      <span class="badge"><span id="pyDot" class="status-dot idle"></span>Python</span>
      <button id="btnToggleFiles" class="btn">Files</button>
      <button id="btnToggleEditor" class="btn">Editor</button>
      <button id="btnToggleAI" class="btn">AI</button>
      <button id="btnToggleTerm" class="btn">Terminal</button>
      <button id="btnClear" class="btn">Clear Log</button>
      <button id="btnPlan" class="btn">Plan</button>
      <button id="btnRun" class="btn primary">Run AI Loop</button>
    </div>
  </div>

  <div id="root" role="main">
    <div class="top-split" id="topSplit">
      <div class="panel" id="filesPanel" style="width:220px;">
        <div class="title">Files</div>
        <div id="file-list"></div>
        <div style="margin-top:8px;display:flex;gap:6px">
          <button id="btnNewFile" class="btn">+ File</button>
          <button id="btnExport" class="btn">Export</button>
        </div>
      </div>

      <div class="panel" id="editorPanel" style="flex:1;display:flex;flex-direction:column;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <input id="ideaInput" class="input" placeholder="Describe idea (e.g. Build a todo app)" />
          <input id="apiInput" class="input" placeholder="Gemini API key (kept in memory)" style="width:360px" />
          <button id="btnSave" class="btn">Save File</button>
        </div>
        <div id="editor"></div>
      </div>

      <div class="panel" id="aiPanel" style="width:260px;">
        <div class="title">AI Assistant / Plan</div>
        <div id="ai-chat" class="log" style="height:45%;overflow:auto"></div>
        <div style="margin-top:8px" class="small">Plan / status</div>
        <div id="planView" class="log" style="height:45%;overflow:auto"></div>
      </div>
    </div>

    <div class="bottom-split" id="bottomSplit">
      <div class="panel" id="termPanel" style="flex:1;">
        <div class="title">Terminal</div>
        <div id="term" class="term-wrapper"></div>
      </div>
      <div class="panel" id="procPanel" style="width:420px;">
        <div class="title">Process Log</div>
        <div id="procLog" class="log" style="height:100%;"></div>
      </div>
    </div>
  </div>

<script>
// layout.js (embedded) - responsive behavior manager
(function layoutManager(){
  const root = document.getElementById('root');
  const filesPanel = document.getElementById('filesPanel');
  const editorPanel = document.getElementById('editorPanel');
  const aiPanel = document.getElementById('aiPanel');
  const termPanel = document.getElementById('termPanel');
  const procPanel = document.getElementById('procPanel');

  function isMobile(){
    return window.matchMedia('(max-width:900px)').matches;
  }

  function applyLayout(){
    if(isMobile()){
      // stack panels vertically
      document.getElementById('topSplit').style.flexDirection = 'column';
      document.getElementById('bottomSplit').style.flexDirection = 'column';
      // hide side extras by default on mobile (user can toggle)
      filesPanel.classList.add('hidden');
      aiPanel.classList.add('hidden');
      termPanel.classList.remove('hidden');
    } else {
      // desktop: show panels
      document.getElementById('topSplit').style.flexDirection = 'row';
      document.getElementById('bottomSplit').style.flexDirection = 'row';
      filesPanel.classList.remove('hidden');
      aiPanel.classList.remove('hidden');
      termPanel.classList.remove('hidden');
      procPanel.classList.remove('hidden');
    }
    // update Split.js sizes (if available)
    if(window.Split) {
      try {
        Split(['#filesPanel', '#editorPanel', '#aiPanel'], { sizes:[18,54,28], minSize:[180,300,220], gutterSize:8 });
        Split(['#termPanel', '#procPanel'], { sizes:[65,35], minSize:[180,200], gutterSize:8 });
      } catch(e) { /* ignore */ }
    }
  }

  window.addEventListener('resize', applyLayout);
  applyLayout();

  // Expose toggles to UI buttons
  document.getElementById('btnToggleFiles').addEventListener('click', ()=> filesPanel.classList.toggle('hidden'));
  document.getElementById('btnToggleEditor').addEventListener('click', ()=> editorPanel.classList.toggle('hidden'));
  document.getElementById('btnToggleAI').addEventListener('click', ()=> aiPanel.classList.toggle('hidden'));
  document.getElementById('btnToggleTerm').addEventListener('click', ()=> termPanel.classList.toggle('hidden'));
})();

// Main IDE script (single-file)
(async ()=>{

/* ========== CONFIG ========== */
const CONFIG = {
  GEMINI_API_KEY: 'AIzaSyClqvUtOslLkXnj6FMrwA77IMuA5NRgTLU',         // default empty - paste in UI OR set here
  MODEL: "gemini-1.5-flash",
  MAX_CYCLES: 6,
  PERSIST_KEY: "ulm-ide-v1",
  AI_TIMEOUT_MS: 30000
};

/* ========== STATE ========== */
const state = {
  files: {
    "index.html": "<!doctype html><html><head><meta charset='utf-8'><title>App</title></head><body><div id='app'>Hello</div><script src='app.js'><\/script></body></html>",
    "app.js": "console.log('app ready');",
    "style.css": "body{font-family:sans-serif;margin:16px}"
  },
  currentFile: "index.html",
  editor: null,
  monaco: null,
  term: null,
  webcontainer: { available:false, instance:null },
  pyodide: { ready:false, instance:null },
  plan: null,
  cycles: 0,
  finished: false
};

/* ========== UI Helpers ========== */
const fileListEl = document.getElementById("file-list");
const planViewEl = document.getElementById("planView");
const aiChatEl = document.getElementById("ai-chat");
const procLogEl = document.getElementById("procLog");
const apiInputEl = document.getElementById("apiInput");
const ideaInputEl = document.getElementById("ideaInput");
const nodeDot = document.getElementById("nodeDot");
const pyDot = document.getElementById("pyDot");

function appendProcLog(s){
  procLogEl.textContent += `[${new Date().toLocaleTimeString()}] ${s}\n`;
  procLogEl.scrollTop = procLogEl.scrollHeight;
}
function appendAI(s, who="AI"){
  aiChatEl.textContent += `${who}: ${s}\n\n`;
  aiChatEl.scrollTop = aiChatEl.scrollHeight;
}
function showPlan(obj){
  planViewEl.textContent = obj ? JSON.stringify(obj, null, 2) : "";
}
function showFiles(){
  fileListEl.innerHTML = "";
  Object.keys(state.files).sort().forEach(path=>{
    const d = document.createElement("div"); d.className="file-item";
    d.innerHTML = `<span>${path}</span><span class="small">${(state.files[path]||"").split("\n").length} ln</span>`;
    d.onclick = ()=> openFile(path);
    fileListEl.appendChild(d);
  });
}

/* ========== Persistence ========== */
async function persist(){ try { await localforage.setItem(CONFIG.PERSIST_KEY, state.files); appendProcLog("Saved project to storage"); } catch(e){ appendProcLog("Persist error: "+e.message); } }
async function restore(){ try { const saved = await localforage.getItem(CONFIG.PERSIST_KEY); if(saved && typeof saved==="object"){ state.files = saved; appendProcLog("Restored project from storage"); } } catch(e){ appendProcLog("Restore error: "+e.message); } }

/* ========== Monaco Editor ========== */
function mountMonaco(containerEl){
  return new Promise((resolve, reject)=>{
    try{
      window.require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.46.0/min/vs' }});
      window.require(['vs/editor/editor.main'], () => {
        state.monaco = monaco;
        state.editor = monaco.editor.create(containerEl, {
          value: state.files[state.currentFile] || "",
          language: langFromPath(state.currentFile),
          theme: "vs-dark",
          automaticLayout: true,
          minimap: { enabled:false },
          fontSize: 14
        });
        state.editor.onDidChangeModelContent(()=> {
          const val = state.editor.getValue();
          state.files[state.currentFile] = val;
        });
        resolve();
      });
    }catch(err){
      reject(err);
    }
  });
}
function langFromPath(p){
  if(!p) return "plaintext";
  if(p.endsWith(".js")) return "javascript";
  if(p.endsWith(".ts")) return "typescript";
  if(p.endsWith(".css")) return "css";
  if(p.endsWith(".html")) return "html";
  if(p.endsWith(".py")) return "python";
  return "plaintext";
}
function openFile(path){
  state.currentFile = path;
  if(state.editor && state.monaco){
    const model = monaco.editor.createModel(state.files[path]||"", langFromPath(path));
    state.editor.setModel(model);
  }
  showFiles();
}

/* ========== Terminal (xterm) ========== */
function mountTerminal(containerEl){
  state.term = new Terminal({ convertEol:true, fontFamily:'monospace', fontSize:13 });
  state.term.open(containerEl);
  state.term.writeln("Ultra Legendary Terminal — ready");
  state.term.onData(data => {
    // future interactive shell
  });
}

/* ========== Preview ========== */
function renderPreview(){
  appendProcLog("Preview updated");
}

/* ========== Gemini helper ========== */
async function ensureApiKey(){
  if(CONFIG.GEMINI_API_KEY && CONFIG.GEMINI_API_KEY.trim() !== "") return CONFIG.GEMINI_API_KEY;
  const v = (apiInputEl.value || "").trim();
  if(v){ CONFIG.GEMINI_API_KEY = v; return v; }
  throw new Error("API key required");
}

async function geminiCall(prompt, timeoutMs = CONFIG.AI_TIMEOUT_MS){
  try{
    const key = await ensureApiKey();
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.MODEL}:generateContent?key=${encodeURIComponent(key)}`;
    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
    appendProcLog("Calling Gemini...");
    const controller = new AbortController();
    const id = setTimeout(()=> controller.abort(), timeoutMs);
    const res = await fetch(url, { method:"POST", headers: { "Content-Type":"application/json" }, signal: controller.signal, body: JSON.stringify(payload) });
    clearTimeout(id);
    const json = await res.json();
    if(json?.candidates?.length){
      const text = json.candidates.map(c => c.content?.parts?.map(p=>p.text).join("") ).join("\n");
      appendProcLog("Gemini OK");
      return text;
    } else if(json?.error){
      appendProcLog("Gemini API error: " + json.error.message);
      return `⚠️ API Error: ${json.error.message}`;
    } else {
      appendProcLog("Gemini responded with no candidates");
      return "⚠️ No response from Gemini";
    }
  }catch(err){
    appendProcLog("Gemini call failed: " + (err.message||err));
    return "⚠️ Connection error: " + (err.message || "");
  }
}

/* ========== JSON extraction helper ========== */
function extractJSON(text){
  if(!text) return null;
  const start = text.indexOf("{");
  const last = text.lastIndexOf("}");
  if(start === -1 || last === -1 || last <= start) return null;
  const candidate = text.slice(start, last+1);
  try { return JSON.parse(candidate); } catch(e){
    const sanitized = candidate.replace(/[“”]/g, '"').replace(/[‘’]/g, "'");
    try { return JSON.parse(sanitized); } catch(e2){ return null; }
  }
}

/* ========== AI flow: plan, implement, test, fix ========== */
async function generatePlan(idea){
  const prompt = `You are a senior engineer. Receive the idea:
"${idea}"
Return ONLY JSON (no extra text). Schema:
{
  "stage":"plan", 
  "idea":"short idea",
  "steps":[{"id":1,"title":"", "description":"", "deliverable":"", "estimated_minutes": 10}],
  "next":"implement"
}`;
  const raw = await geminiCall(prompt);
  appendAI(raw);
  const parsed = extractJSON(raw);
  if(!parsed){
    appendProcLog("Plan parsing failed; using fallback simple plan");
    state.plan = { stage:"plan", idea, steps:[
      {id:1, title:"Scaffold UI", description:"Basic HTML/CSS/JS", deliverable:"index.html, app.js, style.css"},
      {id:2, title:"Core logic", description:"Main feature JS", deliverable:"app.js"},
      {id:3, title:"Polish", description:"Styles & fixes", deliverable:"style.css"}], next:"implement"};
    showPlan(state.plan);
    return state.plan;
  }
  state.plan = parsed;
  showPlan(parsed);
  appendProcLog("Plan saved");
  return parsed;
}

async function implementNextStep(){
  if(!state.plan || !state.plan.steps) throw new Error("No plan available");
  const next = state.plan.steps.find(s=>!s.done);
  if(!next){ appendProcLog("No remaining steps"); return { finished:true }; }
  appendProcLog(`Asking AI to implement step ${next.id}: ${next.title}`);
  const prompt = `You are an expert developer. Implement step ${next.id} ("${next.title}") in our project. Return ONLY JSON with schema:
{
  "stage":"implement",
  "step_id": <number>,
  "files": [{"path":"index.html","content":"<full file content>"}],
  "notes":"short notes",
  "next":"test"
}
Project files snapshot keys: ${Object.keys(state.files).join(", ")}`;
  const raw = await geminiCall(prompt);
  appendAI(raw);
  const parsed = extractJSON(raw);
  if(!parsed){ appendProcLog("Implement parse failed"); return null; }
  (parsed.files || []).forEach(f => { state.files[f.path] = f.content; appendProcLog("Wrote " + f.path); });
  if(parsed.step_id){
    const step = state.plan.steps.find(s=>s.id===parsed.step_id); if(step) step.done = true;
  }
  await persist();
  renderPreview();
  return parsed;
}

async function testProject(){
  appendProcLog("AI running static QA check on project");
  const prompt = `You are QA. Analyze the codebase for obvious issues and return ONLY JSON:
{
  "stage":"test",
  "issues":[{"file":"index.html","line":0,"message":"..."}],
  "next":"fix"|"finish",
  "finished": false
}
Files snapshot: keys: ${Object.keys(state.files).join(", ")}`;
  const raw = await geminiCall(prompt);
  appendAI(raw);
  const parsed = extractJSON(raw);
  if(!parsed){ appendProcLog("Test parse failed; assuming issues present"); return { issues:[{file:"app.js",message:"Could not parse test output"}], next:"fix" }; }
  return parsed;
}

async function fixIssues(issues){
  appendProcLog("Asking AI to fix issues: " + JSON.stringify(issues));
  const prompt = `You are a senior developer. Fix the following issues and return ONLY JSON:
{
  "stage":"fix",
  "files":[{"path":"<string>","content":"<full content>"}],
  "notes":"what you fixed",
  "next":"test"
}
Issues: ${JSON.stringify(issues)}.
Files snapshot keys: ${Object.keys(state.files).join(", ")}`;
  const raw = await geminiCall(prompt);
  appendAI(raw);
  const parsed = extractJSON(raw);
  if(!parsed){ appendProcLog("Fix parse failed"); return null; }
  (parsed.files || []).forEach(f=>{ state.files[f.path] = f.content; appendProcLog("Fixed " + f.path); });
  await persist();
  renderPreview();
  return parsed;
}

/* ========== Orchestrator ========== */
async function runAiLoop(){
  try{
    await ensureApiKey();
  }catch(e){
    alert("Gemini API key required to run AI loop (paste in input)");
    return;
  }
  if(!state.plan){
    const idea = (ideaInputEl.value||"").trim();
    if(!idea){ alert("Enter idea first"); return; }
    await generatePlan(idea);
  }
  // pre-boot sandboxes
  await bootPySafely();
  await bootWebContainerSafely();

  state.cycles = 0;
  state.finished = false;
  appendProcLog("Starting AI loop");
  while(state.cycles < CONFIG.MAX_CYCLES && !state.finished){
    state.cycles++;
    appendProcLog(`Cycle ${state.cycles} start`);
    try{
      const impl = await implementNextStep();
      const test = await testProject();
      if(test?.finished === true || test?.next === "finish"){
        state.finished = true;
        appendProcLog("AI declared finished.");
        appendAI("✅ Finished. Project ready.");
        if(state.term) state.term.writeln("✔️ Project finished by AI.");
        break;
      }
      const issues = test?.issues || [];
      if(issues.length > 0){
        appendProcLog(`Issues found: ${issues.length}`);
        await fixIssues(issues);
      } else {
        appendProcLog("No issues found this cycle; moving to next step or finalizing.");
        const nextStep = state.plan.steps.find(s=>!s.done);
        if(!nextStep){
          const fin = await geminiCall(`All plan steps implemented. Confirm completion. Return JSON {"finished": true} or {"finished": false, "remaining": ["..."]}`);
          appendAI(fin);
          const fjson = extractJSON(fin);
          if(fjson?.finished) { state.finished = true; appendProcLog("Finalized by AI"); break; }
        }
      }
    }catch(err){
      appendProcLog("Cycle error: " + (err.message||err));
    }
  }
  if(!state.finished) appendProcLog("Stopped: reached max cycles or not finished");
}

/* ========== Pyodide boot ========== */
async function bootPySafely(){
  try{
    if(state.pyodide?.ready) return;
    appendProcLog("Booting Pyodide...");
    state.pyodide.instance = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/" });
    state.pyodide.ready = true;
    pyDot.className = "status-dot ok";
    if(state.term) state.term.writeln("Python sandbox ready");
  }catch(e){
    pyDot.className = "status-dot err";
    appendProcLog("Pyodide boot failed: " + (e.message||e));
  }
}

/* ========== WebContainer boot (optional) ========== */
async function bootWebContainerSafely(){
  if(state.webcontainer.available) return;
  try{
    appendProcLog("Loading WebContainer (if available)...");
    let WCmod = null;
    try{
      WCmod = await import('https://cdn.jsdelivr.net/npm/@webcontainer/api@1.3.0/dist/index.min.js');
    }catch(e){
      appendProcLog("WebContainer import failed or blocked; Node sandbox not available.");
      nodeDot.className = "status-dot err";
      state.webcontainer.available = false;
      return;
    }
    const { WebContainer } = WCmod;
    state.webcontainer.instance = await WebContainer.boot();
    state.webcontainer.available = true;
    nodeDot.className = "status-dot ok";
    if(state.term) state.term.writeln("Node sandbox (WebContainer) ready");
    await syncFilesToWebContainer();
  }catch(e){
    appendProcLog("WebContainer boot error: " + (e.message||e));
    nodeDot.className = "status-dot err";
    state.webcontainer.available = false;
  }
}

async function syncFilesToWebContainer(){
  if(!state.webcontainer.available || !state.webcontainer.instance) return;
  try{
    const fs = state.webcontainer.instance.fs;
    for(const [path, content] of Object.entries(state.files)){
      await fs.writeFile(path, new TextEncoder().encode(content));
    }
    if(!state.files["package.json"]){
      const pkg = { name:"ai-ide-project", type:"module", scripts:{ start:"node app.js" } };
      await state.webcontainer.instance.fs.writeFile("package.json", new TextEncoder().encode(JSON.stringify(pkg,null,2)));
    }
    appendProcLog("Synced files to WebContainer FS");
  }catch(e){ appendProcLog("Sync to WebContainer failed: " + (e.message||e)); }
}

/* ========== Utilities & UI hooks ========== */
document.getElementById("btnNewFile").addEventListener("click", ()=>{
  const name = prompt("New file name (e.g. util.js)");
  if(!name) return;
  if(state.files[name]) return alert("File exists");
  state.files[name] = "";
  showFiles();
  openFile(name);
  persist();
});
document.getElementById("btnExport").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state.files,null,2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'project.json'; a.click();
  appendProcLog("Exported project");
});
document.getElementById("btnSave").addEventListener("click", ()=>{
  saveCurrentEditorFile();
  persist();
});
document.getElementById("btnClear").addEventListener("click", ()=>{ procLogEl.textContent = ""; aiChatEl.textContent=""; });
document.getElementById("btnPlan").addEventListener("click", async ()=>{
  const idea = (ideaInputEl.value||"").trim();
  if(!idea) return alert("Write an idea first");
  await generatePlan(idea);
});
document.getElementById("btnRun").addEventListener("click", ()=>{ runAiLoop(); });

function saveCurrentEditorFile(){
  if(!state.editor) return;
  const value = state.editor.getValue();
  state.files[state.currentFile] = value;
  appendProcLog("Saved " + state.currentFile);
  persist();
  renderPreview();
}

/* ========== Init UI, mount monaco & terminal ========== */
async function init(){
  try{ await restore(); }catch(err){ appendProcLog("Restore error: "+(err?.message||err)); }

  showFiles();

  // Monaco mount
  const editorDiv = document.getElementById("editor");
  const monWrapper = document.createElement("div");
  monWrapper.style.height = "100%";
  monWrapper.style.width = "100%";
  editorDiv.appendChild(monWrapper);
  try{
    await mountMonaco(monWrapper);
  }catch(e){
    appendProcLog("Monaco load failed: " + (e.message||e));
    editorDiv.innerHTML = "<div style='color:var(--muted)'>Editor failed to load</div>";
  }

  // terminal
  mountTerminal(document.getElementById("term"));

  // Split layout
  try{
    Split(['#filesPanel', '#editorPanel', '#aiPanel'], { sizes:[18,60,22], minSize:[180,300,220], gutterSize:8 });
    Split(['#termPanel', '#procPanel'], { sizes:[65,35], minSize:[180,200], gutterSize:8 });
  }catch(e){ /* ignore split errors */ }

  // auto boot optional sandboxes
  bootPySafely();
  bootWebContainerSafely();

  appendProcLog("UI ready. Enter idea and press Plan or Run AI Loop.");
}

await init();

})(); // end main IIFE
</script>
</body>
</html>